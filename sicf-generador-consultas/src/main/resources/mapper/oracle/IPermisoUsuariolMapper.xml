<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ob.unibanca.sicf.generadorconsultas.mapper.IPermisoUsuarioMapper">

	<sql id="consultaVistaMant">
       SELECT 
		  ID_PERMISO_USUARIO    AS ID_PERMISO_USUARIO,
		  ID_PERFIL_REP_CAMPO   AS ID_PERFIL_REP_CAMPO,
		  ID_PERFIL_REP_USUARIO AS ID_PERFIL_REP_USUARIO,
          USUARIO               AS USERNAME,
          ID_PERFIL             AS ID_PERFIL,
          PERFIL                AS PERFIL,
          ID_TABLA              AS ID_TABLA,
          TABLA                 AS TABLA,
          ALIAS_TABLA			AS ALIAS_TABLA,
          ID_CAMPO              AS ID_CAMPO,
          CAMPO                 AS CAMPO,
          ID_TIPO_DATO          AS ID_TIPO_DATO,
          ALIAS                 AS ALIAS,
          VER_TRUNCADO          AS VER_TRUNCADO
		FROM VIE_MAN_REP_PERMISO_USUARIO
    </sql>
    <sql id="camposDiferentesPermitidos">
      SELECT DISTINCT
	       ID_TABLA
	     , TABLA
	     , ALIAS_TABLA
	     , ID_CAMPO
	     , CAMPO
	     , ALIAS
	     , ID_TIPO_DATO
	  FROM VIE_MAN_REP_PERMISO_USUARIO
    </sql>

     <select id="buscarTodos" resultType="PermisoUsuario" statementType="PREPARED">
        <include refid="consultaVistaMant"/>
    </select>
	<select id="buscarPorCriterios" resultType="PermisoUsuario" parameterType="CriterioBusquedaPermisoUsuario" statementType="PREPARED">
		<if  test="distinct==1">
	        	 <include refid="camposDiferentesPermitidos"/>	
	    </if>
	    <if  test="distinct!=1">
	        	 <include refid="consultaVistaMant"/>
	    </if>    
        <where>
	        <if  test="distinct!=1">
	          <if  test="idPerfil != null and idPerfil != '' ">
	        	  AND ID_PERFIL = #{idPerfil}	
	           </if>
		    </if> 	  
	            <if  test="username!=null and username!='' ">
	        	  AND USUARIO =#{username}
	           </if>
	           <if  test="tabla != null and tabla != '' ">
	        	  AND TABLA = #{tabla}
	           </if>
	           <if  test="idTabla != null and idTabla != 0 ">
	        	  AND ID_TABLA = #{idTabla}
	           </if>
	           <if  test="idCampo != null and idCampo != 0 ">
	        	  AND ID_CAMPO = #{idCampo}
	           </if>
	     </where>	
    </select>
   
    
     <select id="mantener" parameterType="ParametroMantenimiento" statementType="CALLABLE">
        {
            CALL PKG_MAN_REP.prc_man_rep_permiso_usuario(
                #{modo, 							      jdbcType=VARCHAR, mode=IN},
                #{objetoMantenido.idPermisoUsuario,     jdbcType=INTEGER, mode=INOUT},
                #{objetoMantenido.idPerfilRepUsuario,  jdbcType=NUMERIC, mode=IN},
                #{objetoMantenido.idPerfilRepCampo, 	  jdbcType=NUMERIC, mode=IN},
                #{objetoMantenido.verTruncado , 	      jdbcType=NUMERIC, mode=IN},
                #{usuario, 						          jdbcType=NUMERIC, mode=IN}
            )
        }
    </select>
    
    <select id="actualizarPermisosUsuario" statementType="CALLABLE">
         {
        	CALL prc_update_permisos_usuario (
      			#{idPerfil, 	      	jdbcType=INTEGER, mode=IN},
                #{listaModificacion,   	jdbcType=VARCHAR, mode=IN},
                #{usuario, 				jdbcType=VARCHAR, mode=IN}               
                )
        }
    </select>
    
    
    <select id="buscarTablasPermitidasUsuario" resultType="Tabla" parameterType="String" statementType="PREPARED">
       	SELECT 
		 DISTINCT 
		 ID_TABLA AS ID_TABLA,
		 CASE WHEN ALIAS_TABLA IS NOT NULL THEN ALIAS_TABLA ELSE TABLA END AS ALIAS,
		 TABLA AS NOMBRE
		FROM VIE_MAN_REP_PERMISO_USUARIO
		<where>
			USUARIO = #{username}
		</where>
		
    </select>
</mapper>
